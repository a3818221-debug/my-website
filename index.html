<!DOCTYPE html><html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OG हिंदी रूट फाइंडर — शॉर्ट ऐड्रेस + चौक/मार्केट/ऑटो पॉइंट</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=\"anonymous\">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=\"anonymous\"></script>
  <!-- Turf.js for geometry ops (buffer, distance to line, bbox, etc.) -->
  <script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>
  <style>
    :root{--bg:#0b1020;--panel:#101735;--panel2:#0f1530;--muted:#9fb0e3;--text:#e9edf8;--accent:#6aa3ff;--green:#58e3c1;--amber:#ffd166}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif}
    header{padding:16px;border-bottom:1px solid rgba(255,255,255,.08);position:sticky;top:0;background:linear-gradient(180deg, rgba(15,23,42,.9), rgba(15,23,42,.65));backdrop-filter: blur(6px);z-index:10}
    .wrap{max-width:1300px;margin:0 auto}
    .title{font-weight:800;font-size:clamp(18px,3vw,26px)}
    .sub{color:var(--muted);font-size:14px;margin-top:4px}
    .grid{display:grid;grid-template-columns:1.25fr .75fr;gap:16px;padding:16px}
    @media (max-width:1100px){.grid{grid-template-columns:1fr}}
    .card{background:var(--panel);border:1px solid rgba(255,255,255,.08);border-radius:18px;overflow:hidden}
    .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .input{flex:1;min-width:200px;padding:12px 14px;border-radius:14px;border:1px solid rgba(255,255,255,.12);background:var(--panel2);color:var(--text);outline:none}
    .btn{padding:12px 14px;border-radius:14px;border:1px solid rgba(255,255,255,.12);background:linear-gradient(180deg,#1b254b,#151d3b);color:var(--text);cursor:pointer;font-weight:700}
    .btn:hover{border-color:rgba(255,255,255,.22)}
    .btn.secondary{background:linear-gradient(180deg,#193a37,#132c2a)}
    .sel{padding:12px 14px;border-radius:14px;border:1px solid rgba(255,255,255,.12);background:var(--panel2);color:var(--text)}
    #map{height:74vh;min-height:440px}
    .pane{max-height:74vh;overflow:auto}
    .item{padding:12px 14px;border-bottom:1px solid rgba(255,255,255,.06)}
    .name{font-weight:800}
    .sml{font-size:12px;color:var(--muted)}
    .badge{background:rgba(255,255,255,.08);padding:6px 8px;border-radius:999px;font-size:11px}
    .chips{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
    .chip{padding:4px 8px;border-radius:999px;background:rgba(255,255,255,.08);font-size:12px}
    .steps{counter-reset:st}
    .step{position:relative;padding-left:34px;margin:10px 0}
    .step:before{counter-increment:st;content:counter(st) ".";position:absolute;left:0;top:0.2rem;background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.18);width:24px;height:24px;display:grid;place-items:center;border-radius:8px;font-size:12px}
    .ok{color:var(--green)}
    .warn{color:var(--amber)}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;background:rgba(255,255,255,.08);font-size:12px;margin-left:8px}
    .suggest{position:relative}
    .suggest ul{position:absolute;left:0;right:0;top:44px;background:var(--panel2);border:1px solid rgba(255,255,255,.15);border-radius:12px;max-height:260px;overflow:auto;z-index:20}
    .suggest li{list-style:none;padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.06);cursor:pointer}
    .suggest li:hover{background:rgba(255,255,255,.06)}
    .divider{height:1px;background:rgba(255,255,255,.08);margin:8px 0}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="title">OG हिंदी रूट फाइंडर — शॉर्ट ऐड्रेस + चौक/मार्केट/ऑटो पॉइंट</div>
      <div class="sub">Start (शुरू) और Destination (मंज़िल) भरें • "मेरी लोकेशन" से तुरंत current location • मोड चुनें (कार/पैदल/साइकिल)। System हिंदी में स्थानीय शैली वाले निर्देश बनाता है।</div>
      <div class="row">
        <div class="suggest" style="flex:1">
          <input id="start" class="input" placeholder="Start / शुरू (उदा. घर का पता या Connaught Place)" autocomplete="off" />
          <ul id="sugStart" hidden></ul>
        </div>
        <div class="suggest" style="flex:1">
          <input id="end" class="input" placeholder="Destination / मंज़िल (उदा. Taj Mahal, Agra)" autocomplete="off" />
          <ul id="sugEnd" hidden></ul>
        </div>
        <select id="mode" class="sel">
          <option value="driving">कार</option>
          <option value="walking">पैदल</option>
          <option value="cycling">साइकिल</option>
        </select>
        <select id="fare" class="sel">
          <option value="off">किराया: बंद</option>
          <option value="auto">किराया: ऑटो</option>
          <option value="cab">किराया: कैब</option>
        </select>
        <button id="locBtn" class="btn secondary">मेरी लोकेशन</button>
        <button id="goBtn" class="btn">रूट दिखाएँ</button>
      </div>
    </div>
  </header>  <div class="grid wrap">
    <section class="card">
      <div id="map"></div>
      <div class=\"item sml\" style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
        <span class="badge">Tiles © OpenStreetMap</span>
        <span class="sml">नोट: पब्लिक APIs (Nominatim/OSRM/Overpass) का प्रयोग। भारी ट्रैफिक पर सीमाएँ हो सकती हैं।</span>
      </div>
    </section><aside class="card pane" id="panel">
  <div class="item"><div class="name">यहाँ शॉर्ट ऐड्रेस + निर्देश दिखेंगे</div><div class="sml">Start/Destination भरें और “रूट दिखाएँ” दबाएँ।</div></div>
</aside>

  </div>  <script>
    // ==== Map init
    const map = L.map('map').setView([28.6139,77.2090], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'&copy; OpenStreetMap contributors'}).addTo(map);
    const markers = L.layerGroup().addTo(map);
    const poiLayer = L.layerGroup().addTo(map);
    let routeLayer = L.geoJSON(null, { style: { weight: 6, opacity: 0.9 } }).addTo(map);

    // ==== DOM
    const startInput = document.getElementById('start');
    const endInput = document.getElementById('end');
    const sugStart = document.getElementById('sugStart');
    const sugEnd = document.getElementById('sugEnd');
    const modeSel = document.getElementById('mode');
    const fareSel = document.getElementById('fare');
    const goBtn = document.getElementById('goBtn');
    const locBtn = document.getElementById('locBtn');
    const panel = document.getElementById('panel');

    // ==== Utils
    const RsPerKm = { auto: 15, cab: 25 };
    function escapeHtml(s){
      return String(s||'').replace(/[&<>"']/g, function(m){
        if(m==='&') return '&amp;';
        if(m==='<') return '&lt;';
        if(m==='>') return '&gt;';
        if(m==='"') return '&quot;';
        if(m==='\'') return '&#39;';
        return m;
      });
    }[m]));}
    function fmtKm(m){ if(m < 1000) return Math.round(m)+ ' मीटर'; return (m/1000).toFixed(1) + ' किमी'; }
    function fmtMin(s){ const m = Math.round(s/60); return m + ' मिनट'; }
    function titleOf(name){ return name? name.split(',')[0] : ''; }
    function modeToHi(m){ return m==='driving'?'कार':m==='walking'?'पैदल':'साइकिल'; }
    function fare(kind, meters){ const km = meters/1000; return Math.round(km * (RsPerKm[kind]||0)); }

    function addMarker([lat,lon], html){ return L.marker([lat,lon]).addTo(markers).bindPopup(html||'स्थान'); }
    function clearLayers(){ markers.clearLayers(); routeLayer.clearLayers(); poiLayer.clearLayers(); }

    // ==== Geocoding (Nominatim)
    async function geocode(q){
      const url = new URL('https://nominatim.openstreetmap.org/search');
      url.searchParams.set('format','json');
      url.searchParams.set('q', q);
      url.searchParams.set('limit','6');
      url.searchParams.set('addressdetails','1');
      url.searchParams.set('namedetails','1');
      url.searchParams.set('accept-language','hi,en');
      const data = await overpassFetch(query);

      // 2) Normalize and distance-filter (<= 120 m from route line)
      const pts = [];
      (data.elements||[]).forEach(el=>{
        if(el.type==='node'){
          pts.push({lat:el.lat, lon:el.lon, tags:el.tags||{}, id:el.id});
        }else if(el.type==='way' && el.center){
          pts.push({lat:el.center.lat, lon:el.center.lon, tags:el.tags||{}, id:el.id});
        }
      });

      const lineFeature = { type: 'Feature', geometry: line, properties: {} }; // wrap as Feature for Turf
      const out = [];
      pts.forEach(p=>{
        const dist = turf.pointToLineDistance(turf.point([p.lon,p.lat]), lineFeature, {units:'meters'});
        if(dist <= 120) out.push({...p, dist});
      });

      // 3) Classify
      out.forEach(p=>{
        const t = p.tags||{}; const name = (t.name||'').trim();
        if(t.highway==='traffic_signals' || t.junction==='roundabout' || /Chowk|चौक|Chauraha|चौराहा|Circle/i.test(name)){
          p.kind = 'chowk';
        } else if(t.amenity==='marketplace' || /Market|Bazaar|बाज़ार|मार्केट/i.test(name)){
          p.kind = 'market';
        } else if(t.amenity==='taxi' || t.highway==='bus_stop' || t.public_transport==='platform' || /Auto|Rickshaw|ऑटो/i.test(name)){
          p.kind = 'auto';
        } else {
          p.kind = 'poi';
        }
        p.name = name || (p.kind==='chowk' ? 'चौराहा' : p.kind==='market' ? 'मार्केट' : 'स्टॉप');
      });

      // sort by along-line order using nearest point on line
      out.forEach(p=>{ p.along = turf.nearestPointOnLine(lineFeature, turf.point([p.lon,p.lat])).properties.location; });
      out.sort((a,b)=> a.along - b.along);

      return out;
    }

    // ==== Hindi directions
    function dirWord(mod){
      switch(mod){
        case 'left': return 'बाएँ';
        case 'right': return 'दाएँ';
        case 'straight': return 'सीधे';
        case 'uturn': return 'यू‑टर्न';
        case 'slight left': return 'हल्का बाएँ';
        case 'slight right': return 'हल्का दाएँ';
        case 'sharp left': return 'तेज़ बाएँ';
        case 'sharp right': return 'तेज़ दाएँ';
        default: return 'आगे';
      }
    }
    function stepToHindi(st){
      const t = st.maneuver?.type || 'continue';
      const mod = st.maneuver?.modifier || 'straight';
      const road = st.name? ` (${st.name})` : '';
      const dist = st.distance? `, फिर लगभग ${fmtKm(st.distance)} चलें` : '';
      if(t==='depart') return 'यहाँ से चलना शुरू करें' + (st.name?` — ${st.name}`:'');
      if(t==='arrive') return 'मंज़िल पर पहुँच गए';
      if(t==='roundabout'){
        const exit = st.maneuver && st.maneuver.exit ? st.maneuver.exit : null;
        return `राउंडअबाउट पर ${exit? exit+'वें ':''}निकास लें${road}${dist}`;
      }
      if(t==='turn') return `इस चौराहे पर ${dirWord(mod)} कट लें${road}${dist}`;
      if(t==='fork') return `काट (फॉर्क) पर ${dirWord(mod)} रहें${road}${dist}`;
      if(t==='merge') return `इस सड़क में जुड़ें${road}${dist}`;
      if(t==='on ramp') return `रैंप पर चढ़ें${road}${dist}`;
      if(t==='off ramp') return `रैंप से उतरें${road}${dist}`;
      return `सीधे आगे बढ़ें${road}${dist}`;
    }

    function makeShortAddress(steps, pois){
      // Pick 2-3 major roads and 2-4 major chowks/markets to form a human-style short address
      const bigSteps = steps.filter(s=> (s.distance||0) > 800 && s.name).slice(0,3).map(s=> s.name);
      const chowks = pois.filter(p=> p.kind==='chowk').slice(0,4).map(p=> p.name).filter(Boolean);
      const markets = pois.filter(p=> p.kind==='market').slice(0,2).map(p=> p.name).filter(Boolean);
      const lastRoad = steps.reverse().find(s=> s.name)?.name || '';
      const lines = [];
      if(bigSteps.length) lines.push(`मुख्य सड़कों से जाइए: ${bigSteps.join(' → ')}`);
      if(chowks.length) lines.push(`बीच में बड़े चौक आएँगे: ${chowks.join(', ')}`);
      if(markets.length) lines.push(`रास्ते में प्रमुख मार्केट: ${markets.join(', ')}`);
      if(lastRoad) lines.push(`आख़िरी में ${lastRoad} पर पहुँचकर मंज़िल मिलेगी।`);
      return lines.join('\n');
    }

    function renderPanel(routeData, mode, pois){
      const r = routeData.routes[0];
      const leg = r.legs[0];
      const steps = (leg.steps||[]).slice();
      const totalDist = fmtKm(r.distance);
      const totalDur = fmtMin(r.duration);

      // Top summary + fare
      panel.innerHTML = '';
      const head = document.createElement('div');
      head.className = 'item';
      const fareMode = fareSel.value;
      const fareLine = fareMode!=='off' ? ` • अनुमानित किराया: ₹${fare(fareMode, r.distance)}` : '';
      head.innerHTML = `<div class="name">कुल दूरी: ${totalDist} • समय: ${totalDur}<span class="pill">मोड: ${modeToHi(mode)}</span>${fareLine}</div>`;
      panel.appendChild(head);

      // Short address
      const shortBox = document.createElement('div');
      shortBox.className = 'item';
      shortBox.innerHTML = `<div class="name">शॉर्ट ऐड्रेस (लोकल-स्टाइल)</div>`;
      const pre = document.createElement('pre');
      pre.textContent = makeShortAddress([...steps], pois);
      pre.style.whiteSpace = 'pre-wrap'; pre.style.margin='6px 0 0'; pre.className='sml';
      shortBox.appendChild(pre);
      // Chips with counts
      const chips = document.createElement('div'); chips.className='chips';
      const chowkCount = pois.filter(p=>p.kind==='chowk').length;
      const marketCount = pois.filter(p=>p.kind==='market').length;
      const autoCount = pois.filter(p=>p.kind==='auto').length;
      chips.innerHTML = `<span class="chip">चौक: ${chowkCount}</span><span class="chip">मार्केट: ${marketCount}</span><span class="chip">ऑटो/बस पॉइंट: ${autoCount}</span>`;
      shortBox.appendChild(chips);
      panel.appendChild(shortBox);

      // Steps
      const stepsBox = document.createElement('div'); stepsBox.className='item';
      stepsBox.innerHTML = `<div class="name">स्टेप‑बाय‑स्टेप निर्देश</div>`;
      const list = document.createElement('div'); list.className='steps';
      steps.forEach(st=>{ const d=document.createElement('div'); d.className='step'; d.innerHTML = `<div>${escapeHtml(stepToHindi(st))}</div>`; if(st.name){const r=document.createElement('div'); r.className='sml'; r.textContent = `सड़क/स्थान: ${st.name}`; d.appendChild(r);} list.appendChild(d); });
      stepsBox.appendChild(list); panel.appendChild(stepsBox);

      // POI lists
      const poiBox = document.createElement('div'); poiBox.className='item';
      poiBox.innerHTML = `<div class="name">रास्ते के महत्वपूर्ण पॉइंट</div>`;
      const mk = (title, arr)=>`<div class='sml' style='margin:6px 0'><b>${title}</b><br>${arr.length? arr.map(p=>`• ${escapeHtml(p.name)}`).join('<br>') : '—'}</div>`;
      poiBox.innerHTML += mk('बड़े चौक / सिग्नल', pois.filter(p=>p.kind==='chowk').slice(0,12));
      poiBox.innerHTML += mk('मार्केट / बाज़ार', pois.filter(p=>p.kind==='market').slice(0,10));
      poiBox.innerHTML += mk('ऑटो/बस पॉइंट', pois.filter(p=>p.kind==='auto').slice(0,10));
      panel.appendChild(poiBox);

      const tip = document.createElement('div'); tip.className='item';
      tip.innerHTML = `<span class="sml">ध्यान दें: यह डेटा OpenStreetMap पर आधारित है। कुछ क्षेत्रों में POI नाम उपलब्ध न होने पर step‑names दिखेंगे। सुरक्षा/ट्रैफिक नियमों का पालन करें।</span>`;
      panel.appendChild(tip);
    }

    async function makeRoute(){
      try{
        const a = await readPoint(startInput);
        const b = await readPoint(endInput);
        if(!a || !b){ alert('कृपया Start और Destination चुनें'); return; }
        clearLayers();
        const mode = modeSel.value;
        const data = await fetchRoute(a,b,mode);
        routeLayer.addData(data.routes[0].geometry);
        map.fitBounds(routeLayer.getBounds(), { padding:[30,30] });
        addMarker(a,'<b>शुरुआत</b>'); addMarker(b,'<b>मंज़िल</b>');

        // Build turf line for POI filtering
        const line = data.routes[0].geometry; // GeoJSON LineString
        const pois = await fetchPOIsAlong(line);

        // Draw POIs on map
        pois.forEach(p=>{
          const color = p.kind==='chowk' ? '#4ade80' : p.kind==='market' ? '#60a5fa' : p.kind==='auto' ? '#f59e0b' : '#ddd';
          const m = L.circleMarker([p.lat,p.lon], { radius:6, color, weight:2, fillOpacity:.3 });
          m.bindPopup(`<b>${escapeHtml(p.name)}</b><br><span class='sml'>${p.kind.toUpperCase()}</span>`);
          poiLayer.addLayer(m);
        });

        renderPanel(data, mode, pois);
      }catch(err){
        console.error(err);
        alert('रूट/डाटा नहीं मिल पाया। कृपया थोड़ा अलग लिखकर देखें।');
      }
    }

    // Events
    goBtn.addEventListener('click', makeRoute);
    startInput.addEventListener('keydown', e=>{ if(e.key==='Enter') makeRoute(); });
    endInput.addEventListener('keydown', e=>{ if(e.key==='Enter') makeRoute(); });

    // My location
    locBtn.addEventListener('click', ()=>{
      if(!navigator.geolocation){ alert('Geolocation समर्थित नहीं है।'); return; }
      navigator.geolocation.getCurrentPosition(pos=>{
        const { latitude: lat, longitude: lon } = pos.coords;
        startInput.value = 'मेरी वर्तमान लोकेशन';
        startInput.dataset.lat = lat; startInput.dataset.lon = lon;
        addMarker([lat,lon],'आप यहाँ हैं').openPopup(); map.setView([lat,lon], 14);
      }, ()=> alert('लोकेशन अनुमति दें फिर पुनः प्रयास करें।'));
    });
  </script></body>
</html>
